# Reflection: Concept Document — автозадача + сортировка задач по весам

## Дата: 2026-02-08
## Сложность: Level 2

---

## Краткое описание

Две связанные фичи:
1. Автоматическое создание задачи "Concept Document" при наличии этого пункта в спецификации — шаблон с описанием и чеклистом из 10 пунктов, добавление в `get_item_task_name()`.
2. Система весов (`sort_order`) для управления порядком создания задач из спецификации. Дефолтные веса по расположению items в калькуляторе. Briefing → Concept Document → Symbols → ... → Promo.

---

## Что прошло хорошо

1. **Инкрементальный подход** — задача task template для concept_doc (047) и система весов (048) разделены на две миграции. Каждая самодостаточна.

2. **Весовая система с шагом 10** — позволяет вставлять новые items между существующими без перенумерации (10, 100, 110, 120...).

3. **Сортировка через JOIN в триггере** — `LEFT JOIN task_spec_item_templates ORDER BY sort_order` вместо произвольного `jsonb_each` гарантирует детерминированный порядок.

4. **UI сразу отсортирован** — список шаблонов в админке сортируется по `sort_order`, а не по `item_id`. Админ видит шаблоны в том же порядке, в котором создаются задачи.

---

## Сложности

1. **Два разных места настроек** — пользователь искал веса на странице Calculator (PricingPage), а не на Task Settings. Нужно было явно указать, где находится настройка.

2. **Миграция нужна для видимости данных** — UI готов, но `sort_order` = null до применения миграции. Это нормально для workflow с миграциями, но вызвало путаницу.

---

## Уроки

1. **Указывать точный путь в UI при объяснении** — не "в админке", а "Task Settings → Шаблоны задач из спецификации → Изменить".

2. **Шаблон задачи и шаблон автозадачи — разные таблицы** — `task_auto_templates` (Briefing и другие общие задачи, создаются всегда) vs `task_spec_item_templates` (задачи из items спецификации, создаются при qty > 0). Важно не путать.

3. **Существующие задачи не пересортируются** — `order` задачи задаётся при создании. Изменение `sort_order` шаблона влияет только на новые проекты.

---

## Файлы

### Созданы
- `calculator/supabase/migrations/047_concept_document_task_template.sql` — шаблон задачи + get_item_task_name
- `calculator/supabase/migrations/048_task_sort_order.sql` — sort_order + веса + обновлённый триггер

### Изменены
- `calculator/src/hooks/useTaskSpecItemTemplates.js` — сортировка по sort_order
- `calculator/src/pages/admin/TaskAutoCreationSettingsPage.jsx` — UI: поле sort_order, сортировка списка

---

## Рекомендации

1. При добавлении нового item в калькулятор — всегда задавать sort_order в миграции шаблона
2. Весовую систему можно использовать для переупорядочивания через drag & drop в будущем
