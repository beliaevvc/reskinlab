# Reflection: Task Card Completion & Reorder

**Task ID:** task-card-completion-reorder
**Date:** 4 Февраля 2026
**Complexity:** Level 2 (Enhancement)

---

## Summary

Реализованы улучшения для карточек задач на Kanban доске:
1. Галочка завершения задачи (для админа и AM)
2. Перетаскивание задач внутри колонок для изменения порядка
3. Автоскролл при перетаскивании к краям колонки
4. Улучшение визуальной индикации при перетаскивании

---

## What Went Well

### 1. Модульный подход к реализации
- Галочка завершения добавлена в оба компонента (`TaskCard` и `TaskDetailModal`) с единообразным поведением
- Логика toggle работает одинаково везде: done → todo, другой статус → done

### 2. Переиспользование существующих хуков
- Использован существующий `useUpdateTaskStatus` для изменения статуса
- Создан новый `useReorderTask` по аналогии с существующими хуками

### 3. Визуальная индикация
- Зелёная полоска показывает позицию вставки при перетаскивании
- Обводка колонки при наведении с задачей
- Завершённые задачи визуально выделены (серый фон, зачёркнутый текст)

### 4. Итеративное улучшение
- Быстрое реагирование на фидбек пользователя
- Несколько итераций для достижения правильного поведения обводки и скролла

---

## Challenges Encountered

### 1. Автоскролл при перетаскивании
**Проблема:** Первая реализация с `setInterval` не работала корректно
**Решение:** Переписано на `requestAnimationFrame` с использованием refs для direction и container

### 2. Обводка колонки перекрывалась скроллбаром
**Проблема:** `ring-2 ring-inset` рисовался под скроллбаром
**Попытки решения:**
- `shadow-[inset_0_0_0_2px]` — не помогло
- `border-2` — работает, но не поверх скролла
**Решение:** Абсолютно позиционированный div с `z-10` и `pointer-events-none`

### 3. Определение позиции вставки
**Проблема:** Нужно определить куда вставить задачу при drop
**Решение:** Использование `getBoundingClientRect()` и сравнение `clientY` с серединой элемента

---

## Lessons Learned

### 1. requestAnimationFrame vs setInterval
Для плавных анимаций и частых обновлений (скролл) лучше использовать `requestAnimationFrame`:
- Синхронизирован с частотой обновления экрана
- Не блокирует UI
- Автоматически останавливается когда вкладка неактивна

### 2. Z-index для overlay элементов
Когда нужно нарисовать что-то поверх скроллбара:
- Использовать абсолютно позиционированный элемент
- `inset-0` для покрытия всего контейнера
- `pointer-events-none` чтобы не блокировать взаимодействие
- `z-10` чтобы быть выше содержимого

### 3. Order-based сортировка
Для изменения порядка элементов в списке:
- Использовать числовое поле `order`
- Вычислять среднее между соседями при вставке
- Использовать большой шаг (1000) для избежания коллизий

---

## Technical Improvements

### Новые хуки
- `useReorderTask()` — обновление статуса и порядка задачи

### Обновлённые компоненты
- `TaskCard.jsx` — добавлена галочка, визуальные стили для done
- `TaskDetailModal.jsx` — добавлена галочка перед названием
- `KanbanBoard.jsx` — drag & drop с позиционированием, автоскролл, overlay обводка

### Props добавлены
- `TaskCard`: `canToggleComplete`, `onToggleComplete`
- `KanbanBoard`: `canToggleComplete`

---

## Process Improvements

### Для будущих задач
1. **Тестировать drag & drop на больших списках** — автоскролл критичен для UX
2. **Overlay элементы для визуальных эффектов** — не зависят от overflow и z-index контента
3. **Использовать refs для анимаций** — избегать лишних ререндеров

---

## Files Modified

### Components
- `calculator/src/components/tasks/TaskCard.jsx`
- `calculator/src/components/tasks/TaskDetailModal.jsx`
- `calculator/src/components/tasks/KanbanBoard.jsx`

### Hooks
- `calculator/src/hooks/useTasks.js` — добавлен `useReorderTask`

### Pages
- `calculator/src/pages/projects/ProjectPage.jsx` — передача `canToggleComplete`

---

## Next Steps

- [ ] Тестирование с большим количеством задач
- [ ] Возможно добавить анимацию при перемещении
- [ ] Рассмотреть оптимистичные обновления для мгновенного feedback
