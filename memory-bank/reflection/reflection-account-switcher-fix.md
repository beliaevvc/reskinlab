# Reflection: Account Switcher Fix

**Дата:** 4 февраля 2026  
**Уровень сложности:** Level 1 (Bug Fix)  
**Статус:** Завершено

---

## Краткое описание

Исправлена проблема с переключением аккаунтов через AccountSwitcher — при переключении профиль пользователя не обновлялся, UI показывал данные старого пользователя.

---

## Что пошло хорошо

1. **Быстрая локализация проблемы** — анализ логов в консоли ("Skipping SIGNED_IN event") сразу указал на область проблемы в AuthContext.

2. **Эффективная debug-инструментация** — добавленные логи подтвердили гипотезу на первой же итерации:
   - `signIn` успешно возвращал нового пользователя
   - `SIGNED_IN` event пропускался
   - `fetchProfile` не вызывался для нового пользователя

3. **Минимальное исправление** — добавлено всего 4 строки кода в функцию `signIn()` без изменения общей архитектуры.

4. **Связанное исправление** — попутно исправлен React warning про вложенные `<button>` элементы в AccountSwitcher.

---

## Проблемы и вызовы

1. **Конфликт между двумя требованиями:**
   - Нужно пропускать `SIGNED_IN` event при перезагрузке страницы (чтобы избежать зависающих запросов)
   - Но при переключении аккаунтов нужно загружать профиль нового пользователя

2. **Асинхронность React state** — логи после `signIn()` показывали старые значения `user`/`profile` из-за closure, что изначально могло запутать при анализе.

---

## Уроки

1. **Пропуск событий имеет побочные эффекты** — когда пропускаем обработку события (SIGNED_IN) для решения одной проблемы, нужно убедиться что функционал, зависящий от этого события, всё ещё работает.

2. **Явные вызовы надёжнее event-driven подхода** — вызов `fetchProfile()` напрямую в `signIn()` надёжнее, чем полагаться на событие `onAuthStateChange`.

3. **Документация критических паттернов** — обновление `systemPatterns.md` помогает избежать повторения подобных проблем в будущем.

---

## Техническое решение

```javascript
// В функции signIn() после успешной авторизации:
if (data?.user) {
  setUser(data.user);
  await fetchProfile(data.user.id, true); // force=true для обхода кеша
}
```

**Почему это работает:**
- `signIn()` вызывается напрямую, не через event listener
- К моменту возврата `signInWithPassword()` токен уже готов
- Явный вызов гарантирует загрузку профиля независимо от событий

---

## Изменённые файлы

1. `calculator/src/contexts/AuthContext.jsx` — добавлен явный вызов `fetchProfile()` в `signIn()`
2. `calculator/src/components/admin/AccountSwitcher.jsx` — исправлен warning про вложенные кнопки
3. `memory-bank/systemPatterns.md` — добавлена документация паттерна

---

## Рекомендации на будущее

1. При изменении логики обработки auth событий — проверять все сценарии использования (login, logout, switch account, page reload)

2. Использовать debug-режим с логами для подтверждения гипотез перед исправлением
