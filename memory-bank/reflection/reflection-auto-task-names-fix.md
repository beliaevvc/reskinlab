# Reflection: Auto Task Names Fix

**Date:** 2026-02-04  
**Task:** Исправление названий автоматически создаваемых задач и улучшение UX

## Summary

Исправлен комплекс багов связанных с автоматическим созданием задач при первой оплате проекта:
- Названия задач не соответствовали названиям в калькуляторе (показывались сырые item_id)
- Задачи и стадии не появлялись автоматически в UI после подтверждения платежа
- Триггер не обрабатывал проекты в статусе 'draft'
- Лишняя плашка "Initialize Stages" в админке

## What Went Well

1. **Быстрая диагностика корневой причины**
   - Сравнение `categories.js` с функцией `get_item_task_name` сразу выявило несоответствие названий
   - SQL-запросы помогли подтвердить что задачи создаются, но с неправильными названиями

2. **Инкрементальные исправления**
   - Каждое исправление тестировалось отдельно
   - Это позволило изолировать проблемы

3. **Комплексное решение**
   - Исправлена функция в БД
   - Обновлены существующие шаблоны и задачи
   - Улучшен UX с автоматическим обновлением кэша

## Challenges

1. **Несколько связанных проблем**
   - Изначально казалось что проблема только в названиях
   - Обнаружились дополнительные баги: триггер не создавал стадии, кэш не инвалидировался

2. **Разные queryKey для stages**
   - В `useStages.js` использовался queryKey `['stages']`
   - В инвалидации использовался `['workflowStages']`
   - Требовалось время на отладку

3. **Статус проекта 'draft'**
   - Триггер обновлял только проекты со статусом 'active' или 'pending_payment'
   - Новые проекты создавались в статусе 'draft'

## Lessons Learned

1. **Согласованность именования**
   - Названия item_id и их отображаемые имена должны храниться в одном месте
   - Калькулятор (`categories.js`) должен быть источником истины

2. **Кэш React Query**
   - При выполнении server-side операций (триггеры) необходимо инвалидировать соответствующие queryKey
   - Важно проверять какие именно queryKey используются в хуках

3. **Тестирование полного флоу**
   - Баги часто проявляются только при прохождении полного пользовательского сценария
   - Нужно тестировать от начала до конца

## Technical Details

### Изменённые файлы:
- `calculator/src/hooks/useInvoices.js` - добавлена инвалидация кэша tasks/stages
- `calculator/src/hooks/useProjects.js` - инвалидация при удалении проекта
- `calculator/src/pages/projects/ProjectPage.jsx` - удалена плашка Initialize Stages
- `calculator/src/components/tasks/TaskDetailModal.jsx` - удалена секция "Связь со спецификацией"
- `calculator/src/components/tasks/TaskCard.jsx` - удалены бейджи spec_item_id
- `calculator/supabase/migrations/028_fix_item_names_from_calculator.sql` - миграция для названий

### SQL изменения (применены в Supabase):
1. Обновлена функция `get_item_task_name` с правильными названиями
2. Обновлены шаблоны в `task_spec_item_templates`
3. Исправлены существующие задачи с сырыми item_id
4. Обновлён триггер `auto_create_tasks_on_first_payment`:
   - Добавлен 'draft' в допустимые статусы проекта
   - Добавлено создание всех 7 стадий при первой оплате

## Process Improvements

1. **Единый источник истины для названий**
   - Рассмотреть возможность генерации SQL-маппинга из `categories.js`
   - Или хранить названия только в БД и загружать в калькулятор

2. **Автоматические тесты**
   - Добавить тест на соответствие item_id в калькуляторе и в функции БД

## Next Steps

- Коммит изменений в git
- Мониторинг работы автоматического создания задач на продакшене
