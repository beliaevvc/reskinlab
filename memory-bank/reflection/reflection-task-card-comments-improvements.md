# Reflection: Task Card & Comments Improvements

**Date:** 4 Февраля 2026
**Task ID:** task-card-comments-improvements
**Complexity:** Level 2 (Multiple related improvements)

---

## Summary

Комплексное улучшение карточек задач и системы комментариев:
- UI улучшения карточек задач (убрано Stage, Unassigned, лишний футер)
- Ограничение прав клиентов (нельзя редактировать название/описание)
- Система отслеживания непрочитанных комментариев
- Система уведомлений (notifications) для будущего использования
- Возможность админа удалять любые комментарии

---

## What Went Well

### 1. UI улучшения
- Быстро выполнены простые задачи по удалению ненужных элементов
- Логика условного отображения футера (только если есть контент) — чистое решение
- Ограничение прав клиентов реализовано просто через `isClient` проверку

### 2. Система отслеживания комментариев
- Создана таблица `comment_reads` с правильной RLS политикой
- Логика подсчёта непрочитанных (исключая свои комментарии) реализована корректно
- Визуальное отображение (зелёный цвет, формат "2/7") понятное

### 3. Система уведомлений
- Создана универсальная таблица `notifications` — можно использовать для разных типов уведомлений
- Триггер создаёт уведомления автоматически при новых комментариях
- Добавлена обработка ошибок (EXCEPTION) чтобы не блокировать основной функционал

### 4. Удаление комментариев админом
- Простое решение через RLS политику с проверкой роли
- UI с подтверждением уже был — только расширили условие

---

## Challenges

### 1. Supabase Realtime vs HTTP блокировка
**Проблема:** Realtime WebSocket блокирует HTTP запросы при перезагрузке страницы (известная проблема, задокументирована в systemPatterns.md).

**Попытки решения:**
1. Пробовали включить Realtime для таблицы notifications
2. Настроили подписку в AppLayout
3. Всё равно не работало + риск сломать авторизацию

**Решение:** Вернулись к polling (каждые 10 секунд) — надёжно работает.

### 2. Триггер notifications сломал комментарии
**Проблема:** После применения миграции 030 комментарии не отправлялись (404 ошибка).

**Причина:** Функция `notify_on_new_comment()` использовала несуществующую таблицу `project_members`.

**Решение:** 
1. Отключили триггер (DROP TRIGGER)
2. Исправили функцию под реальную структуру БД (projects → clients → user_id)
3. Добавили EXCEPTION блок для предотвращения блокировки

### 3. Структура БД отличалась от ожиданий
**Проблема:** Предполагали таблицу project_members, а связь пользователей с проектами через clients.user_id и projects.am_id.

**Урок:** Всегда проверять реальную структуру БД перед написанием триггеров.

---

## Lessons Learned

### 1. Realtime в Supabase — не серебряная пуля
- Требует тщательной настройки RLS
- Может конфликтовать с HTTP запросами
- Для небольших проектов polling — достаточное решение

### 2. Триггеры должны быть отказоустойчивыми
- Всегда добавлять EXCEPTION блок
- Триггер не должен блокировать основную операцию
- Логировать ошибки (RAISE WARNING) для отладки

### 3. Проверять структуру БД
- Перед написанием сложных функций — изучить schema
- Не предполагать существование таблиц
- Использовать реальные связи (FK constraints)

### 4. systemPatterns.md — важный ресурс
- Документирует известные проблемы и решения
- Нужно проверять перед изменениями критических систем
- Помогает избежать повторения ошибок

---

## Technical Decisions

### Polling vs Realtime
**Выбор:** Polling каждые 10 секунд
**Причина:** Realtime блокирует HTTP запросы при перезагрузке
**Trade-off:** Задержка до 10 секунд vs надёжность

### Система уведомлений
**Создано:** Таблица notifications + триггер
**Пока не используется:** Нет UI для отображения (колокольчик)
**Готово для будущего:** Email уведомления, push notifications

### Comment reads отслеживание
**Подход:** Отдельная таблица + подсчёт в useTasks
**Альтернатива:** Добавить поле last_read_at в задачи (проще, но менее гибко)

---

## Files Changed

### New Migrations
- `029_comment_reads_tracking.sql` — таблица отслеживания прочитанных комментариев
- `030_notifications_system.sql` — система уведомлений
- `031_fix_notifications_trigger.sql` — исправленный триггер
- `032_admin_delete_any_comment.sql` — RLS для удаления комментариев

### Modified Components
- `TaskDetailModal.jsx` — убран Stage, ограничены права клиента
- `TaskCard.jsx` — убран Unassigned, условный футер, индикатор непрочитанных
- `CommentItem.jsx` — админ может удалять любые комментарии

### Modified Hooks
- `useTasks.js` — подсчёт комментариев и непрочитанных, polling
- `useComments.js` — инвалидация tasks при добавлении комментария

### New Hooks (не используются пока)
- `useNotifications.js` — работа с уведомлениями (для будущего)

---

## Next Steps

1. **UI для уведомлений** — добавить колокольчик в хедер с dropdown списком
2. **Email уведомления** — Edge Function для отправки email
3. **Оптимизация polling** — возможно уменьшить интервал для активных страниц
4. **Исследовать Supabase Realtime** — возможно есть способ обойти блокировку HTTP

---

## Metrics

- **Время выполнения:** ~2 часа
- **Миграций создано:** 4
- **Файлов изменено:** ~10
- **Основных проблем:** 2 (Realtime блокировка, триггер ошибка)
- **Откатов:** 1 (Realtime → polling)
