# Reflection: Per-item Order Type (Art / Animation / Both)

## Task ID: per-item-order-type
## Date: 2026-02-07
## Complexity: Level 2

---

## Summary

Реализована возможность выбора типа заказа для каждой позиции калькулятора: **Art Only**, **Anim Only**, **Art+Anim**. Это позволяет клиентам заказывать только арт (без анимации), только анимацию (если арт уже есть), или оба вместе (поведение по умолчанию).

---

## What Went Well

1. **Чистая архитектура изменений** — вся логика `orderType` добавлена в существующий хук `useCalculator.js` без изменения его интерфейса для потребителей. `CalculatorPage.jsx` и `CalculatorModal.jsx` не потребовали изменений для базовой функциональности расчёта.

2. **Обратная совместимость** — fallback `state.orderType || 'art_and_anim'` во всех местах чтения гарантирует, что старые спецификации без `orderType` работают как раньше. Миграций БД не потребовалось (JSONB).

3. **Итеративный UX-дизайн** — переключатель прошёл несколько итераций на основе обратной связи пользователя:
   - `A+A | Art | Anim` → неочевидно
   - `Both | Art Only | Anim Only` → "Both" непонятно
   - `Art+Anim | Art Only | Anim Only` → финальный вариант
   - Порядок: `Art Only | Anim Only | Art+Anim` (дефолт последним)

4. **Глобальный дефолт** — вместо простого массового переключения реализован `defaultOrderType`, который автоматически применяется к новым позициям при активации. Это значительно удобнее для UX.

5. **Умная логика анимации** — `None` убран из опций при Art+Anim и Anim Only (анимация обязательна). Автоподстановка `AN-L` при переключении на режим с обязательной анимацией.

---

## Challenges

1. **Дублирование кода Page/Modal** — как и в предыдущей задаче (Specification Inheritance), пришлось вносить изменения в два места: `CalculatorPage.jsx` и `CalculatorModal.jsx`. Это повторяющийся паттерн, который увеличивает surface area для ошибок.

2. **Tailwind JIT и динамические классы** — первая попытка использовать `border-${color}-200` не работает с Tailwind JIT. Быстро обнаружено и исправлено на полные классы в объекте конфигурации.

3. **Координация состояний** — при переключении `orderType` нужно синхронизировать `anim` (сброс в none для Art Only, автоподстановка AN-L для остальных). Это реализовано в трёх местах: `handleOrderTypeChange` (ItemRow), `setAllOrderType` (useCalculator), `updateItem` при активации (useCalculator).

---

## Lessons Learned

1. **Tailwind: никогда не интерполировать классы** — всегда использовать полные строки классов. Это фундаментальное правило Tailwind JIT, которое легко забыть.

2. **UX: итерация > перфекционизм** — лейблы прошли 4 итерации за 5 минут. Быстрый фидбек пользователя гораздо эффективнее долгого продумывания.

3. **Глобальный дефолт vs массовое действие** — пользователь предложил сделать переключатель, который не только меняет текущие позиции, но и устанавливает дефолт для будущих. Это более интуитивная модель, чем "применить ко всем".

4. **Один переключатель лучше нескольких** — первоначальная реализация показывала кнопки над каждой категорией. Пользователь правильно заметил, что одного набора сверху достаточно. Меньше визуального шума.

---

## Technical Improvements

1. **Рассмотреть извлечение общего калькулятора** — дублирование логики между `CalculatorPage.jsx` и `CalculatorModal.jsx` — системная проблема. Стоит рассмотреть общий компонент `CalculatorEditor` с пропсами для контекстных отличий.

2. **ORDER_TYPES как константа в data/** — сейчас `ORDER_TYPES` определён inline в `ItemRow.jsx`, а bulk-варианты — inline в двух page-файлах. Стоит вынести в `data/orderTypes.js` как единый source of truth.

---

## Files Modified

### Core Logic
- `calculator/src/hooks/useCalculator.js` — формула расчёта, `orderType` в state, `defaultOrderType`, `setAllOrderType`, авто-применение при активации

### UI Components
- `calculator/src/components/ItemRow.jsx` — сегментированный переключатель per-item, фильтрация `None` из опций анимации
- `calculator/src/components/CategorySection.jsx` — обновлённые заголовки колонок (добавлен Type)
- `calculator/src/components/SpecificationView.jsx` — колонка Type с цветными бейджами

### Pages (bulk switcher)
- `calculator/src/pages/calculator/CalculatorPage.jsx` — глобальный переключатель, проброс `defaultOrderType`
- `calculator/src/components/project/CalculatorModal.jsx` — то же для модалки

---

## Metrics

- **Файлов изменено:** 6
- **Файлов создано:** 0
- **Миграций БД:** 0 (JSONB — поле добавляется автоматически)
- **Итераций UX:** 4 (лейблы, порядок, расположение, логика None)
