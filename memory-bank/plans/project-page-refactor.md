# План рефакторинга страницы проекта

## Обзор изменений

### Текущее состояние
- 4 отдельные страницы: Overview, Workspace, Files, Delivery
- Навигация через табы (ProjectTabs)
- Канбан на отдельной вкладке Workspace
- Стадии проекта отдельно от канбана
- Файлы в отдельном разделе

### Целевое состояние
- **Одна страница проекта** с канбаном как основой
- **Левая сворачиваемая панель** со спеками/офертами
- **Компактный header** с инфо о проекте + прогресс стадий
- **Единый интерфейс** для всех ролей (разница только в функциях)
- **Role Switcher** для админа в шапке проекта

---

## Архитектура решения

### Новая структура компонентов

```
src/pages/projects/
├── ProjectPage.jsx          # НОВЫЙ - единая страница проекта
├── ProjectsPage.jsx         # Без изменений - список проектов
└── [УДАЛИТЬ]
    ├── ProjectDetailPage.jsx
    ├── ProjectWorkspacePage.jsx
    ├── ProjectFilesPage.jsx
    └── ProjectDeliveryPage.jsx

src/components/project/      # НОВАЯ папка
├── ProjectHeader.jsx        # Header с инфо + статистика
├── ProjectSidebar.jsx       # Левая сворачиваемая панель
├── ProjectStages.jsx        # Progress bar стадий
├── RoleSwitcher.jsx         # Переключатель роли для админа
├── SpecOfferCard.jsx        # Карточка Spec+Offer
├── FilesGalleryModal.jsx    # Модальное окно всех файлов
└── index.js

src/components/tasks/
├── KanbanBoard.jsx          # МОДИФИКАЦИЯ - 5 колонок
├── TaskCard.jsx             # МОДИФИКАЦИЯ - attachments, approvals
├── TaskDetailModal.jsx      # МОДИФИКАЦИЯ - файлы внутри
└── ...
```

### Новая структура лейаута

```
┌─────────────────────────────────────────────────────────────────┐
│  [Role Switcher: Admin ▼]     PROJECT HEADER                    │
│  Project Name | Client | Status | Due Date | Stats              │
├─────────────────────────────────────────────────────────────────┤
│  ○────●────○────○────○  STAGES PROGRESS BAR                     │
│  Concept  Art  Review  QA  Delivery                             │
├────────────┬────────────────────────────────────────────────────┤
│            │                                                    │
│  LEFT      │              KANBAN BOARD                          │
│  SIDEBAR   │                                                    │
│  (collaps) │  ┌────────┬────────┬────────┬────────┬────────┐   │
│            │  │Backlog │ To Do  │In Prog │ Review │  Done  │   │
│ ┌────────┐ │  │        │        │        │        │        │   │
│ │ Specs  │ │  │ □ Task │ □ Task │ □ Task │ □ Task │ □ Task │   │
│ │ +Offers│ │  │ □ Task │ □ Task │        │        │ □ Task │   │
│ └────────┘ │  │        │        │        │        │        │   │
│            │  └────────┴────────┴────────┴────────┴────────┘   │
│ ┌────────┐ │                                                    │
│ │Project │ │                                                    │
│ │ Info   │ │                                                    │
│ └────────┘ │                                                    │
│            │                                                    │
│ [Collapse] │                                                    │
└────────────┴────────────────────────────────────────────────────┘
```

---

## Фазы реализации

### ФАЗА 1: Базовая структура (Foundation)
**Цель:** Создать скелет нового лейаута без ломания текущего функционала

#### 1.1 Создание новых компонентов-оболочек
- [ ] `ProjectPage.jsx` — новая единая страница
- [ ] `ProjectHeader.jsx` — шапка с базовой инфо
- [ ] `ProjectSidebar.jsx` — сворачиваемая панель (пустая)
- [ ] `ProjectStages.jsx` — progress bar стадий

#### 1.2 Модификация роутинга
- [ ] Добавить route `/projects/:id` → `ProjectPage`
- [ ] Старые routes (`/workspace`, `/files`, `/delivery`) временно оставить
- [ ] Добавить флаг `USE_NEW_PROJECT_PAGE` для переключения

#### 1.3 Интеграция существующего KanbanBoard
- [ ] Перенести KanbanBoard в новый лейаут
- [ ] Убедиться что drag-n-drop работает

**Результат:** Работающая страница с канбаном в новом лейауте

---

### ФАЗА 2: Канбан 5 колонок + Стадии
**Цель:** Расширить канбан, настроить связь со стадиями

#### 2.1 Модификация KanbanBoard
- [ ] Добавить колонку "Backlog" (status: `backlog`)
- [ ] Обновить TASK_STATUSES: `['backlog', 'todo', 'in_progress', 'review', 'done']`
- [ ] Миграция БД: добавить `backlog` в CHECK constraint

#### 2.2 ProjectStages компонент
- [ ] Горизонтальный progress bar с точками
- [ ] Кликабельные стадии (для staff — можно менять)
- [ ] Визуальное выделение текущей стадии
- [ ] Delivery как финальная стадия

#### 2.3 Интеграция Delivery в стадии
- [ ] Добавить stage_key: `delivery` в DEFAULT_STAGES
- [ ] При переходе в Delivery — показывать final approval flow
- [ ] Убрать отдельную логику DeliveryPage

**Результат:** Канбан с 5 колонками, стадии как progress bar

---

### ФАЗА 3: Левая панель (Sidebar)
**Цель:** Сворачиваемая панель со спеками, офертами, инфо

#### 3.1 ProjectSidebar структура
- [ ] Состояние collapsed/expanded (localStorage)
- [ ] Анимация сворачивания
- [ ] Кнопка toggle

#### 3.2 Секция Specs + Offers
- [ ] `SpecOfferCard` — объединённая карточка
- [ ] Статус спеки (draft/finalized)
- [ ] Статус оферты (если есть)
- [ ] Кнопки: View, Edit (открывает модалку)

#### 3.3 Секция Project Info
- [ ] Клиент (название, контакт)
- [ ] Account Manager
- [ ] Даты (создан, дедлайн)
- [ ] Quick actions для staff

#### 3.4 Модальные окна
- [ ] `SpecificationModal` — просмотр/редактирование спеки
- [ ] `OfferModal` — просмотр оферты
- [ ] Интеграция с существующими компонентами

**Результат:** Полнофункциональная левая панель

---

### ФАЗА 4: Файлы и Approvals
**Цель:** Интегрировать файлы в задачи, approvals в карточки

#### 4.1 Файлы в задачах
- [ ] Модификация `TaskCard` — показывать кол-во attachments
- [ ] Модификация `TaskDetailModal` — секция файлов
- [ ] Upload файлов внутри задачи
- [ ] Preview файлов

#### 4.2 FilesGalleryModal
- [ ] Модальное окно со всеми файлами проекта
- [ ] Группировка по задачам
- [ ] Метаданные: дата загрузки, кто загрузил, в какой задаче
- [ ] Фильтры и поиск
- [ ] Кнопка открытия в header проекта

#### 4.3 Approvals в задачах
- [ ] Badge на TaskCard если нужен approval
- [ ] Индикатор pending approval
- [ ] Quick approve/reject в карточке
- [ ] Полный flow в TaskDetailModal

**Результат:** Файлы и approvals интегрированы в задачи

---

### ФАЗА 5: Role Switcher + Права
**Цель:** Переключение роли для админа, правильные права для всех

#### 5.1 RoleSwitcher компонент
- [ ] Dropdown в header проекта (только для admin)
- [ ] Опции: "Admin", "View as AM", "View as Client"
- [ ] Плашка-индикатор при эмуляции
- [ ] Сохранение в sessionStorage (сбрасывается при закрытии)

#### 5.2 Контекст ViewAsRole
- [ ] `useViewAsRole()` hook
- [ ] Интеграция с AuthContext
- [ ] `effectiveRole` — реальная роль с учётом эмуляции

#### 5.3 Права по ролям
- [ ] **Client:**
  - ✅ Просмотр всех задач
  - ✅ Просмотр файлов
  - ✅ Approve/Reject deliverables
  - ❌ Создание задач
  - ❌ Drag-n-drop задач
  - ❌ Изменение стадий
  - ❌ Удаление
- [ ] **AM:**
  - ✅ Всё что может клиент
  - ✅ Создание задач
  - ✅ Drag-n-drop
  - ✅ Изменение стадий
  - ❌ Удаление проекта
- [ ] **Admin:**
  - ✅ Полный доступ
  - ✅ Role Switcher

**Результат:** Корректные права, админ может тестировать другие роли

---

### ФАЗА 6: Cleanup и Polish
**Цель:** Удалить старый код, отполировать UI

#### 6.1 Удаление старых страниц
- [ ] Удалить `ProjectDetailPage.jsx`
- [ ] Удалить `ProjectWorkspacePage.jsx`
- [ ] Удалить `ProjectFilesPage.jsx`
- [ ] Удалить `ProjectDeliveryPage.jsx`
- [ ] Удалить `ProjectTabs.jsx`

#### 6.2 Очистка роутов
- [ ] Удалить routes `/workspace`, `/files`, `/delivery`
- [ ] Убрать флаг `USE_NEW_PROJECT_PAGE`
- [ ] Обновить все ссылки в приложении

#### 6.3 UI Polish
- [ ] Responsive design (mobile/tablet)
- [ ] Анимации переходов
- [ ] Loading states
- [ ] Error states
- [ ] Empty states

#### 6.4 Тестирование
- [ ] Тест всех ролей
- [ ] Тест drag-n-drop
- [ ] Тест файлов
- [ ] Тест approvals
- [ ] Тест stадий

**Результат:** Чистый код, готовый к продакшену

---

## Миграция базы данных

### Новая миграция: `006_project_refactor.sql`

```sql
-- 1. Добавить статус backlog для задач
ALTER TABLE public.tasks 
DROP CONSTRAINT IF EXISTS tasks_status_check;

ALTER TABLE public.tasks
ADD CONSTRAINT tasks_status_check 
CHECK (status IN ('backlog', 'todo', 'in_progress', 'review', 'done'));

-- 2. Обновить существующие задачи (опционально)
-- UPDATE tasks SET status = 'backlog' WHERE status = 'todo' AND stage_id IS NULL;

-- 3. Добавить delivery в стадии (если нет)
-- Это делается через код при инициализации стадий
```

---

## Зависимости между фазами

```
ФАЗА 1 ──────┐
             │
ФАЗА 2 ──────┼──→ ФАЗА 3 ──────┐
             │                  │
             └──────────────────┼──→ ФАЗА 4 ──→ ФАЗА 5 ──→ ФАЗА 6
```

- Фаза 1 и 2 можно делать параллельно частично
- Фаза 3 зависит от базового лейаута (Фаза 1)
- Фаза 4 зависит от канбана (Фаза 2) и sidebar (Фаза 3)
- Фаза 5 можно начать после Фазы 3
- Фаза 6 только после завершения всех предыдущих

---

## Оценка сложности

| Фаза | Описание | Сложность | Компоненты |
|------|----------|-----------|------------|
| 1 | Foundation | Medium | 4 новых компонента |
| 2 | Kanban + Stages | Medium | Модификация + миграция |
| 3 | Sidebar | Medium-High | 4 компонента + модалки |
| 4 | Files + Approvals | High | Много интеграций |
| 5 | Role Switcher | Medium | Context + UI |
| 6 | Cleanup | Low | Удаление + polish |

**Общая оценка:** Level 4 (Архитектурные изменения)

---

## Риски и митигация

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Сломать текущий функционал | Средняя | Высокое | Feature flag, постепенный переход |
| Проблемы с drag-n-drop | Низкая | Среднее | Тестирование на каждом этапе |
| Сложность с правами | Средняя | Среднее | Чёткая документация ролей |
| Responsive issues | Средняя | Среднее | Mobile-first подход |

---

## Чеклист готовности к началу

- [ ] Текущий код закоммичен
- [ ] Бэкап базы данных
- [ ] Понимание всех компонентов
- [ ] Согласование с пользователем

---

## Следующий шаг

**Начать с Фазы 1:** Создание базовой структуры и нового лейаута.
