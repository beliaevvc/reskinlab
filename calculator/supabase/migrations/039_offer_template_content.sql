-- ============================================================
-- Migration 039: Move from blocks to single content field
-- ============================================================
-- Removes the block-based editor in favor of a single content
-- field on offer_templates for a unified editing experience.
-- ============================================================

-- 1. Add content column to offer_templates
ALTER TABLE public.offer_templates
  ADD COLUMN IF NOT EXISTS content JSONB DEFAULT '{}';

-- 2. Migrate existing blocks → single content text
UPDATE public.offer_templates ot
SET content = sub.migrated
FROM (
  SELECT
    b.template_id,
    jsonb_build_object(
      'text',
      string_agg(
        COALESCE(b.content ->> 'text', ''),
        E'\n\n'
        ORDER BY b.sort_order
      )
    ) AS migrated
  FROM public.offer_template_blocks b
  GROUP BY b.template_id
) sub
WHERE ot.id = sub.template_id;

-- 3. Fallback: if any template still has empty content, seed it with the standard offer text
UPDATE public.offer_templates
SET content = jsonb_build_object(
  'text',
  E'ОФЕРТА НА ОКАЗАНИЕ УСЛУГ ПО СОЗДАНИЮ ВИЗУАЛЬНОГО КОНТЕНТА\n\n1. ПРЕДМЕТ ОФЕРТЫ\n\nИсполнитель (ReSkin Lab, далее — «Студия») настоящим предлагает Заказчику (далее — «Клиент») заключить договор на оказание услуг по созданию визуальных материалов в соответствии с прилагаемой Спецификацией.\n\nСпецификация является неотъемлемой частью настоящей оферты и содержит детальное описание объёма работ, включая:\n• Перечень создаваемых визуальных элементов\n• Выбранный стиль оформления\n• Условия использования (лицензия)\n• Количество включённых раундов правок\n\n2. СТОИМОСТЬ И ПОРЯДОК ОПЛАТЫ\n\nОбщая стоимость услуг: {{grand_total}}\n\nОплата производится в криптовалюте USDT (Tether) на кошелёк Студии.\nПоддерживаемые сети: TRC20 (Tron) или ERC20 (Ethereum).\n\nГрафик платежей:\n• 50% — предоплата (до начала работ)\n• 25% — по завершении этапа производства\n• 25% — финальный платёж (перед передачей материалов)\n\nПримечание: Конкретные суммы и сроки платежей указаны в выставленных инвойсах.\n\n3. СРОКИ ВЫПОЛНЕНИЯ\n\nСроки выполнения работ зависят от объёма проекта и текущей загрузки Студии.\nОриентировочные сроки будут согласованы после получения предоплаты.\n\nОферта действительна до: {{valid_until}}\n\nПосле истечения срока действия оферты Студия оставляет за собой право пересмотреть условия и стоимость работ.\n\n4. АКЦЕПТ ОФЕРТЫ\n\nАкцепт (принятие) настоящей оферты осуществляется Клиентом путём:\n1. Ознакомления с полным текстом оферты и Спецификации\n2. Подтверждения согласия с условиями (нажатие кнопки «Принять оферту»)\n3. Внесения предоплаты согласно выставленному инвойсу\n\nМомент акцепта фиксируется в системе с сохранением:\n• Даты и времени акцепта\n• IP-адреса Клиента\n• Идентификатора браузера\n• Полной копии условий оферты\n\n5. ИНТЕЛЛЕКТУАЛЬНАЯ СОБСТВЕННОСТЬ\n\n5.1. Все создаваемые материалы являются объектами интеллектуальной собственности.\n\n5.2. Права на использование передаются Клиенту в соответствии с выбранной лицензией, указанной в Спецификации, после полной оплаты.\n\n5.3. До момента полной оплаты все права на материалы принадлежат Студии.\n\n5.4. Студия сохраняет право использовать созданные материалы в портфолио и маркетинговых целях, если иное не оговорено отдельно.\n\n6. ПРАВКИ И ИЗМЕНЕНИЯ\n\n6.1. Количество раундов правок, включённых в стоимость, указано в Спецификации.\n\n6.2. Дополнительные правки сверх включённых оплачиваются отдельно по согласованным тарифам.\n\n6.3. Существенные изменения в объёме или концепции проекта после начала работ могут потребовать пересмотра стоимости и сроков.\n\n7. РАЗРЕШЕНИЕ СПОРОВ\n\n7.1. Стороны обязуются решать все возникающие разногласия путём переговоров.\n\n7.2. При невозможности достичь согласия споры подлежат разрешению в соответствии с применимым законодательством.\n\n8. ПРОЧИЕ УСЛОВИЯ\n\n8.1. Настоящая оферта является публичной и адресована неопределённому кругу лиц.\n\n8.2. Клиент подтверждает, что ознакомлен со всеми условиями оферты, понимает их и принимает в полном объёме.\n\n8.3. Студия оставляет за собой право вносить изменения в типовые условия оферты. Принятые офферты сохраняют свои условия на момент акцепта.\n\nВерсия условий: {{terms_version}}\nДата публикации: {{publish_date}}\n\n© ReSkin Lab — Premium Visual Content Studio'
)
WHERE name = 'Стандартная оферта'
  AND (content IS NULL OR content = '{}'::jsonb OR content ->> 'text' IS NULL OR content ->> 'text' = '');
